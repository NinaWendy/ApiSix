#=======================
# Global settings
#=======================
global
    log /dev/log local0
    maxconn 5000
    user haproxy
    group haproxy
    daemon
    stats socket /run/haproxy/admin.sock mode 660 level admin
    stats timeout 30s

#=======================
# Default settings
#=======================
defaults
    log global
    mode http
    option httplog
    option dontlognull
    timeout connect 5s
    timeout client 50s
    timeout server 50s
    option redispatch
    retries 3

#=======================
# HAProxy Stats Dashboard
#=======================
listen stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 10s
    stats auth admin:admin    # change credentials
    acl favicon path_beg /favicon.ico
    http-request deny if favicon

#=======================
# APISIX Frontend
#=======================
frontend apisix_frontend
    bind *:80
    mode http
    default_backend apisix_backends

#=======================
# APISIX Backend Cluster
#=======================
backend apisix_backends
    mode http
    balance leastconn

    # Perform health checks against /health route in APISIX
    option httpchk GET /health HTTP/1.1\r\nHost:localhost
    http-check expect status 200

    # APISIX nodes
    server node1 192.168.10.11:9080 check inter 5s fall 3 rise 2
    server node2 192.168.10.12:9080 check inter 5s fall 3 rise 2
    server node3 192.168.10.13:9080 check inter 5s fall 3 rise 2
